#!/usr/bin/perl 
#===============================================================================
#
#        USAGE:  ./wifi.pl  
#
#  DESCRIPTION:  In theory - this scrit should make all dirty job with wifi 
#                connection.
#
#       AUTHOR:  chesh1r (twitter.com/chesh1r), cheshir.box@gmail.com
#      VERSION:  0.1
#===============================================================================

use strict;
use Getopt::Long;
Getopt::Long::Configure('bundling');


my $iface           = "wlan0";
my $essid           = "teh.box";
my $addr            = 192.168.0.1;
my $addr_min        = 192.168.0.10;
my $addr_max        = 192.168.0.126;
my $netmask         = 255.255.255.0;
my $channel         = 3;
my ($up, $down, $get, $firewall);

die "Usage: wifi -[u|uf|d|g] \n"
    unless GetOptions(
    'u|new_ad-hoc'          => \$up,
    'f|firestarter'         => \$firewall,
    'd|stop_ad-hoc'         => \$down,
    'g|connect_to_ad-hoc'   => \$get,
    );

if (($up || ($up && $firewall)) && !$down && !$get) {
    print "Up... ";
    exec "ifconfig wlan0 down";
    exec "iwconfig wlan0 mode ad-hoc";
    exec "iwconfig wlan0 channel $channel";
    exec "iwconfig wlan0 essid $essid ";
    exec "ifconfig wlan0 up";
    exec "ifconfig wlan0 $addr";
    exec "firestarter --start-hidden&" if ($firewall);
    print "ok!\n";
}

elsif ($down && !$up && !$get && !$firewall) {
    print "Terminateing... ";
    exec "ifconfig wlan0 down";
    exec "iwconfig wlan0 mode managedr";
    exec "killall firestarter" if (`ps aux` =~ "firestarter");
    exec "ifconfig wlan0 up";
    print "ok!\n";
}

elsif ($get && !$up && !$down && !$firewall) {
    print "Connect... ";
    my $scan = `iwlist wlan0 scan`;
    $essid = s/.*ESSID:"(.*)".*/$1/g;
    $channel = s/.*Channel:(\d{1,2}).*/$1/g;
    exec "ifconfig wlan0 down";
    exec "iwconfig wlan0 mode ad-hoc";
    exec "iwconfig wlan0 channel $channel";
    exec "iwconfig wlan0 essid $essid ";
    exec "ifconfig wlan0 up";
    exec "dhclient3 wlan0";
    print "ok!\n";
}

else { print "wtf?" }
